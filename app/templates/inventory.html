<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcureIQ — Inventory</title>
    <meta name="description" content="ProcureIQ ERP Inventory Management System">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-[#f8f9fb] min-h-screen">

    <!-- ── Navbar ──────────────────────────────────────────────────────── -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-[1400px] mx-auto px-6 md:px-8 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
                <div class="bg-gray-900 w-8 h-8 rounded-lg flex items-center justify-center">
                    <i data-lucide="shield-check" class="w-4 h-4 text-white"></i>
                </div>
                <span class="text-[15px] font-semibold text-gray-900">ProcureIQ</span>
                <span class="text-gray-300 font-light">/</span>
                <span class="text-[15px] text-gray-500">Inventory</span>
            </div>
            <div class="flex items-center gap-3">
                <a href="/"
                    class="h-8 px-4 rounded-lg border border-gray-200 text-gray-600 text-[13px] font-medium flex items-center gap-1.5 hover:bg-gray-50 transition-colors">
                    <i data-lucide="layout-dashboard" class="w-3.5 h-3.5"></i> Dashboard
                </a>
                <a href="/settings"
                    class="h-8 px-4 rounded-lg border border-gray-200 text-gray-600 text-[13px] font-medium flex items-center gap-1.5 hover:bg-gray-50 transition-colors">
                    <i data-lucide="settings" class="w-3.5 h-3.5"></i> Settings
                </a>
            </div>
        </div>
    </nav>

    <!-- ── Main Content ────────────────────────────────────────────────── -->
    <main class="max-w-[1400px] mx-auto px-6 md:px-8 py-6 space-y-6">

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="package" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-medium text-gray-400 uppercase tracking-wide">Total Products</p>
                        <p id="stat-total" class="text-xl font-bold text-gray-900">—</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-medium text-gray-400 uppercase tracking-wide">Low Stock</p>
                        <p id="stat-low" class="text-xl font-bold text-amber-600">—</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-red-50 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="x-circle" class="w-5 h-5 text-red-500"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-medium text-gray-400 uppercase tracking-wide">Out of Stock</p>
                        <p id="stat-oos" class="text-xl font-bold text-red-500">—</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="indian-rupee" class="w-5 h-5 text-emerald-600"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-medium text-gray-400 uppercase tracking-wide">Inventory Value</p>
                        <p id="stat-value" class="text-xl font-bold text-emerald-600">—</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
            <div class="flex flex-col sm:flex-row gap-3">
                <div class="relative flex-1">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                    <input id="search-input" type="text" placeholder="Search by SKU or product name..."
                        class="w-full h-9 pl-9 pr-4 rounded-lg border border-gray-200 text-sm text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-200 focus:border-gray-300 transition-all"
                        oninput="debouncedFetch()">
                </div>
                <select id="filter-category" title="Filter by category"
                    class="h-9 px-3 rounded-lg border border-gray-200 text-sm text-gray-600 bg-white focus:outline-none focus:ring-2 focus:ring-gray-200 cursor-pointer"
                    onchange="fetchInventory()">
                    <option value="">All Categories</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Accessories">Accessories</option>
                    <option value="Office Equipment">Office Equipment</option>
                    <option value="Networking">Networking</option>
                    <option value="Peripherals">Peripherals</option>
                    <option value="Storage Devices">Storage Devices</option>
                </select>
                <select id="filter-status" title="Filter by status"
                    class="h-9 px-3 rounded-lg border border-gray-200 text-sm text-gray-600 bg-white focus:outline-none focus:ring-2 focus:ring-gray-200 cursor-pointer"
                    onchange="fetchInventory()">
                    <option value="">All Status</option>
                    <option value="In Stock">In Stock</option>
                    <option value="Low Stock">Low Stock</option>
                    <option value="Out of Stock">Out of Stock</option>
                </select>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full min-w-[900px]">
                    <thead class="bg-gray-50 border-b border-gray-100">
                        <tr>
                            <th
                                class="text-left text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                SKU</th>
                            <th
                                class="text-left text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Product Name</th>
                            <th
                                class="text-left text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Category</th>
                            <th
                                class="text-left text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Brand</th>
                            <th
                                class="text-left text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Supplier</th>
                            <th
                                class="text-right text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Stock</th>
                            <th
                                class="text-right text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Reorder</th>
                            <th
                                class="text-right text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Cost</th>
                            <th
                                class="text-right text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Sell</th>
                            <th
                                class="text-center text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Status</th>
                            <th
                                class="text-left text-[10px] font-medium text-gray-400 uppercase tracking-wider px-5 py-3">
                                Location</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-tbody" class="divide-y divide-gray-50">
                        <tr>
                            <td colspan="11" class="py-16 text-center text-gray-400 text-sm">Loading inventory...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="px-5 py-3 border-t border-gray-100 flex items-center justify-between bg-gray-50/50">
                <p id="pagination-info" class="text-xs text-gray-400"></p>
                <div class="flex items-center gap-1.5">
                    <button id="btn-prev" onclick="changePage(-1)" disabled
                        class="h-7 px-3 text-[11px] font-medium text-gray-500 border border-gray-200 rounded-lg hover:bg-white transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                        ← Prev
                    </button>
                    <span id="page-num"
                        class="h-7 px-3 text-[11px] font-medium text-gray-700 bg-white border border-gray-200 rounded-lg inline-flex items-center">1</span>
                    <button id="btn-next" onclick="changePage(1)"
                        class="h-7 px-3 text-[11px] font-medium text-gray-500 border border-gray-200 rounded-lg hover:bg-white transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                        Next →
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- ── JavaScript ──────────────────────────────────────────────────── -->
    <script>
        const API_KEY = "{{ api_key }}";
        const getHeaders = () => ({ "X-API-Key": API_KEY, "Content-Type": "application/json" });

        let currentPage = 1;
        const pageSize = 20;
        let debounceTimer = null;

        function debouncedFetch() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => { currentPage = 1; fetchInventory(); }, 300);
        }

        async function fetchSummary() {
            try {
                const res = await fetch('/api/inventory/summary', { headers: getHeaders() });
                const d = await res.json();
                document.getElementById('stat-total').textContent = d.total;
                document.getElementById('stat-low').textContent = d.low_stock;
                document.getElementById('stat-oos').textContent = d.out_of_stock;
                document.getElementById('stat-value').textContent = '₹' + Number(d.total_value).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            } catch (e) { console.error('Summary fetch failed', e); }
        }

        async function fetchInventory() {
            const search = document.getElementById('search-input').value.trim();
            const category = document.getElementById('filter-category').value;
            const status = document.getElementById('filter-status').value;

            const params = new URLSearchParams({ page: currentPage, page_size: pageSize });
            if (search) params.set('search', search);
            if (category) params.set('category', category);
            if (status) params.set('status', status);

            const tbody = document.getElementById('inventory-tbody');

            try {
                const res = await fetch(`/api/inventory?${params}`, { headers: getHeaders() });
                const d = await res.json();

                const items = d.items || [];
                const total = d.total || 0;
                const totalPages = Math.ceil(total / pageSize) || 1;

                // Pagination controls
                document.getElementById('pagination-info').textContent = `Showing ${items.length} of ${total} items`;
                document.getElementById('page-num').textContent = currentPage;
                document.getElementById('btn-prev').disabled = currentPage <= 1;
                document.getElementById('btn-next').disabled = currentPage >= totalPages;

                if (items.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="11" class="py-16 text-center text-gray-400 text-sm">
                        <div class="flex flex-col items-center gap-2">
                            <i data-lucide="package-open" class="w-8 h-8 text-gray-200"></i>
                            <span>No inventory items found.</span>
                        </div>
                    </td></tr>`;
                    lucide.createIcons();
                    return;
                }

                tbody.innerHTML = items.map(item => {
                    let statusCls, statusBg;
                    if (item.status === 'Out of Stock') {
                        statusCls = 'text-red-600'; statusBg = 'bg-red-50 border-red-100';
                    } else if (item.status === 'Low Stock') {
                        statusCls = 'text-amber-600'; statusBg = 'bg-amber-50 border-amber-100';
                    } else {
                        statusCls = 'text-emerald-600'; statusBg = 'bg-emerald-50 border-emerald-100';
                    }

                    const updated = item.last_updated ? new Date(item.last_updated).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '—';

                    return `<tr class="hover:bg-gray-50/60 transition-colors">
                        <td class="px-5 py-3 text-xs font-mono text-gray-500">${item.sku}</td>
                        <td class="px-5 py-3">
                            <p class="text-sm font-medium text-gray-900">${item.product_name}</p>
                            <p class="text-[10px] text-gray-400 mt-0.5">${updated}</p>
                        </td>
                        <td class="px-5 py-3 text-xs text-gray-500">${item.category || '—'}</td>
                        <td class="px-5 py-3 text-xs text-gray-600 font-medium">${item.brand || '—'}</td>
                        <td class="px-5 py-3 text-xs text-gray-500">${item.supplier || '—'}</td>
                        <td class="px-5 py-3 text-right text-sm font-mono ${item.stock_quantity <= item.reorder_level ? 'text-red-600 font-semibold' : 'text-gray-800'}">${item.stock_quantity}</td>
                        <td class="px-5 py-3 text-right text-sm text-gray-400">${item.reorder_level}</td>
                        <td class="px-5 py-3 text-right text-sm text-gray-600">₹${item.cost_price.toFixed(2)}</td>
                        <td class="px-5 py-3 text-right text-sm text-gray-800 font-medium">₹${item.selling_price.toFixed(2)}</td>
                        <td class="px-5 py-3 text-center">
                            <span class="h-5 px-2 rounded-md text-[9px] font-semibold uppercase tracking-wide ${statusCls} ${statusBg} border inline-flex items-center">${item.status}</span>
                        </td>
                        <td class="px-5 py-3 text-xs text-gray-400">${item.warehouse_location || '—'}</td>
                    </tr>`;
                }).join('');

            } catch (e) {
                console.error('Inventory fetch failed', e);
                tbody.innerHTML = `<tr><td colspan="11" class="py-16 text-center text-red-400 text-sm">Failed to load inventory data.</td></tr>`;
            }
        }

        function changePage(delta) {
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            fetchInventory();
        }

        // Init
        fetchSummary();
        fetchInventory();
        lucide.createIcons();
    </script>

</body>

</html>