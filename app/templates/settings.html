<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcureIQ | ERP Connection Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-black p-1.5 rounded-lg">
                    <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                </div>
                <h1 class="text-xl font-extrabold tracking-tight">ProcureIQ <span
                        class="text-gray-400 font-medium">Settings</span></h1>
            </div>
            <a href="/"
                class="bg-slate-900 hover:bg-black text-white px-5 py-2 rounded-xl text-sm font-bold transition-all flex items-center gap-2 shadow-lg active:scale-95">
                <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                Back to Dashboard
            </a>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-6 py-8" x-data="appSettings()">

        <!-- Tabs -->
        <div class="flex gap-2 mb-6">
            <button @click="tab='erp'"
                :class="tab==='erp' ? 'bg-black text-white' : 'bg-white text-gray-600 border border-gray-200'"
                class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all">
                üîå ERP Connection
            </button>
            <button @click="tab='credentials'; loadCredentials()"
                :class="tab==='credentials' ? 'bg-black text-white' : 'bg-white text-gray-600 border border-gray-200'"
                class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all">
                üîë API Credentials
            </button>
            <button @click="tab='notifications'; loadNotifSettings()"
                :class="tab==='notifications' ? 'bg-black text-white' : 'bg-white text-gray-600 border border-gray-200'"
                class="px-5 py-2.5 rounded-xl text-sm font-bold transition-all">
                üìß Notifications
            </button>
        </div>


        <!-- ‚ïê‚ïê‚ïê ERP TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div x-show="tab==='erp'">
            <!-- Current Connection Status -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl" :class="connected ? 'bg-green-50' : 'bg-gray-50'">
                            <i data-lucide="database" class="w-6 h-6"
                                :class="connected ? 'text-green-600' : 'text-gray-400'"></i>
                        </div>
                        <div>
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Active ERP Connection
                            </h3>
                            <p class="text-lg font-bold text-gray-900 mt-0.5" x-text="currentName"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wider"
                            :class="connected ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'"
                            x-text="connected ? 'Connected' : 'Not Tested'"></span>
                        <span
                            class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wider bg-blue-100 text-blue-700"
                            x-text="currentType"></span>
                    </div>
                </div>
            </div>

            <!-- Connection Form -->
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-gray-100 bg-gray-50/50">
                    <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
                        Configure ERP Connection
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Connect your ERP system or use the built-in Python Sample DB
                        for
                        demos.</p>
                </div>

                <form @submit.prevent="saveConnection()" class="p-6 space-y-6">
                    <!-- Connection Name -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Connection
                            Name</label>
                        <input x-model="form.connection_name" type="text" placeholder="e.g., Production Database"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                    </div>

                    <!-- ERP Type -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">ERP
                            Type</label>
                        <select x-model="form.erp_type"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all bg-white">
                            <option value="python_db">Python Sample DB (Demo)</option>
                            <option value="sap">SAP S/4HANA</option>
                            <option value="netsuite">Oracle NetSuite</option>
                            <option value="custom">Custom API</option>
                        </select>
                    </div>

                    <!-- Real ERP Fields (shown when not python_db) -->
                    <template x-if="form.erp_type !== 'python_db'">
                        <div class="space-y-6 p-5 bg-gray-50 rounded-xl border border-gray-100">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">API
                                    URL</label>
                                <input x-model="form.api_url" type="url" placeholder="https://your-erp.example.com"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">API
                                    Key
                                    / Password</label>
                                <input x-model="form.api_key" type="password" placeholder="Enter API key or password"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Database
                                        Name</label>
                                    <input x-model="form.database_name" type="text" placeholder="e.g., production_db"
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Username</label>
                                    <input x-model="form.username" type="text" placeholder="admin@company.com"
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Test Result -->
                    <div x-show="testResult" class="p-4 rounded-xl border text-sm font-medium"
                        :class="testSuccess ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'">
                        <div class="flex items-center gap-2">
                            <i :data-lucide="testSuccess ? 'check-circle' : 'x-circle'" class="w-4 h-4"></i>
                            <span x-text="testResult"></span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 pt-2">
                        <button type="button" @click="testConnection()"
                            class="flex-1 px-5 py-3.5 border-2 border-gray-200 rounded-xl text-sm font-bold text-gray-700 hover:bg-gray-50 transition-all flex items-center justify-center gap-2 active:scale-95"
                            :disabled="testing">
                            <i data-lucide="wifi" class="w-4 h-4"></i>
                            <span x-text="testing ? 'Testing...' : 'Test Connection'"></span>
                        </button>
                        <button type="submit"
                            class="flex-1 bg-slate-900 hover:bg-black text-white px-5 py-3.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95"
                            :disabled="saving">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span x-text="saving ? 'Saving...' : 'Save & Activate'"></span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Architecture Info -->
            <div class="mt-8 bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
                <h3 class="font-bold text-sm text-gray-800 flex items-center gap-2 mb-3">
                    <i data-lucide="info" class="w-4 h-4 text-blue-500"></i>
                    About This Architecture
                </h3>
                <p class="text-sm text-gray-600 leading-relaxed">
                    ProcureIQ uses an <strong>ERP Adapter pattern</strong> ‚Äî the AI agent works with a unified interface
                    regardless of whether you're using the built-in Python Sample DB or a real ERP system.
                    Switch between backends without changing a single line of agent code.
                </p>
                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="p-3 bg-gray-50 rounded-xl text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">Python DB</p>
                        <p class="text-sm font-bold text-gray-800 mt-1">Default</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-xl text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">Custom</p>
                        <p class="text-sm font-bold text-gray-800 mt-1">REST API</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-xl text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">SAP</p>
                        <p class="text-sm font-bold text-gray-800 mt-1">OData</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-xl text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">NetSuite</p>
                        <p class="text-sm font-bold text-gray-800 mt-1">REST</p>
                    </div>
                </div>
            </div>
        </div><!-- end ERP tab -->


        <!-- ‚ïê‚ïê‚ïê CREDENTIALS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div x-show="tab==='credentials'">

            <!-- Security Notice -->
            <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-6 flex items-start gap-3">
                <i data-lucide="shield-alert" class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"></i>
                <div>
                    <p class="text-sm font-bold text-amber-800">Keys are never displayed in full</p>
                    <p class="text-xs text-amber-700 mt-0.5">To reveal a saved key, you must re-verify with Google. Keys
                        are stored securely in the database ‚Äî not in code.</p>
                </div>
            </div>

            <!-- Re-auth Banner -->
            <template x-if="!reauthVerified">
                <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-6 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i data-lucide="lock" class="w-5 h-5 text-blue-600"></i>
                        <p class="text-sm font-semibold text-blue-800">Want to reveal saved keys? Re-verify with Google
                            first.</p>
                    </div>
                    <a href="/auth/reauth"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2">
                        <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                        Verify Identity
                    </a>
                </div>
            </template>
            <template x-if="reauthVerified">
                <div class="bg-green-50 border border-green-200 rounded-2xl p-3 mb-6 flex items-center gap-3">
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                    <p class="text-sm font-semibold text-green-800">Identity verified ‚Äî you can reveal keys for 5
                        minutes.</p>
                </div>
            </template>

            <!-- Credential Cards -->
            <div class="space-y-3" x-show="credentials.length > 0">
                <template x-for="cred in credentials" :key="cred.key">
                    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold text-gray-500 uppercase tracking-widest"
                                        x-text="cred.description"></span>
                                    <span x-show="cred.from_db"
                                        class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] font-extrabold rounded-full uppercase">DB</span>
                                    <span x-show="!cred.from_db && cred.is_set"
                                        class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-extrabold rounded-full uppercase">.env</span>
                                    <span x-show="!cred.is_set"
                                        class="px-2 py-0.5 bg-gray-100 text-gray-500 text-[10px] font-extrabold rounded-full uppercase">Not
                                        Set</span>
                                </div>
                                <p class="text-xs text-gray-400 font-mono" x-text="cred.key"></p>
                                <!-- Masked / Revealed value -->
                                <p class="mt-2 text-sm font-mono text-gray-700 tracking-widest"
                                    x-text="revealedKeys[cred.key] || cred.masked_value"></p>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <!-- Reveal button (only when re-authed) -->
                                <button x-show="reauthVerified && cred.is_set && !revealedKeys[cred.key]"
                                    @click="revealKey(cred.key)"
                                    class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-50 transition-all flex items-center gap-1">
                                    <i data-lucide="eye" class="w-3.5 h-3.5"></i> Reveal
                                </button>
                                <!-- Update button -->
                                <button @click="openEdit(cred)"
                                    class="px-3 py-1.5 bg-black text-white rounded-lg text-xs font-bold hover:bg-gray-800 transition-all flex items-center gap-1">
                                    <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                                    <span x-text="cred.is_set ? 'Update' : 'Set'"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Edit Modal -->
            <div x-show="editingCred" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
                @click.self="editingCred=null">
                <div class="bg-white rounded-2xl shadow-2xl p-7 w-full max-w-md mx-4">
                    <h3 class="font-bold text-lg text-gray-900 mb-1" x-text="editingCred?.description"></h3>
                    <p class="text-xs text-gray-400 font-mono mb-5" x-text="editingCred?.key"></p>

                    <label class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 block">New
                        Value</label>
                    <input x-model="editValue" type="password" placeholder="Paste your key here..."
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm font-mono focus:outline-none focus:ring-2 focus:ring-black/20 transition-all mb-2">
                    <p class="text-xs text-gray-400 mb-5">‚ö†Ô∏è The field uses password masking ‚Äî your key won't be visible
                        while typing.</p>

                    <div x-show="saveMessage" class="p-3 rounded-xl text-xs font-bold mb-4"
                        :class="saveSuccess ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'"
                        x-text="saveMessage"></div>

                    <div class="flex gap-3">
                        <button @click="editingCred=null; editValue=''; saveMessage=''"
                            class="flex-1 px-4 py-3 border border-gray-200 rounded-xl text-sm font-bold text-gray-600 hover:bg-gray-50 transition-all">
                            Cancel
                        </button>
                        <button @click="saveKey()"
                            class="flex-1 bg-black text-white px-4 py-3 rounded-xl text-sm font-bold hover:bg-gray-800 transition-all flex items-center justify-center gap-2"
                            :disabled="savingKey">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            <span x-text="savingKey ? 'Saving...' : 'Save Key'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div><!-- end credentials tab -->

        <script>
            const API_KEY = "{{ api_key }}";
            const getHeaders = () => ({
                "X-API-Key": API_KEY,
                "Content-Type": "application/json"
            });

            function appSettings() {
                return {
                    // Tab state
                    tab: new URLSearchParams(window.location.search).get('tab') || 'erp',

                    // ERP tab state
                    currentName: 'Loading...',
                    currentType: '...',
                    connected: false,
                    testing: false,
                    saving: false,
                    testResult: '',
                    testSuccess: false,
                    form: {
                        connection_name: 'Python Sample DB',
                        erp_type: 'python_db',
                        api_url: '',
                        api_key: '',
                        database_name: '',
                        username: ''
                    },

                    // Credentials tab state
                    credentials: [],
                    reauthVerified: false,
                    editingCred: null,
                    editValue: '',
                    savingKey: false,
                    saveMessage: '',
                    saveSuccess: false,
                    revealedKeys: {},

                    async init() {
                        await this.fetchCurrentConnection();
                        await this.checkReauthStatus();
                        if (this.tab === 'credentials') await this.loadCredentials();
                        // Auto-open credentials tab if ?tab=credentials
                        if (new URLSearchParams(window.location.search).get('verified')) {
                            this.tab = 'credentials';
                            await this.loadCredentials();
                        }
                        this.$nextTick(() => lucide.createIcons());
                    },

                    // ‚îÄ‚îÄ‚îÄ ERP Methods ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    async fetchCurrentConnection() {
                        try {
                            const res = await fetch('/api/erp/current', { headers: getHeaders() });
                            const data = await res.json();
                            this.currentName = data.connection_name || 'Python Sample DB';
                            this.currentType = data.erp_type || 'python_db';
                            this.connected = data.test_status === 'success';
                            this.form.connection_name = data.connection_name || 'Python Sample DB';
                            this.form.erp_type = data.erp_type || 'python_db';
                            this.form.api_url = data.api_url || '';
                        } catch (err) {
                            console.error('Failed to fetch current connection', err);
                        }
                    },

                    async testConnection() {
                        this.testing = true;
                        this.testResult = '';
                        try {
                            const res = await fetch('/api/erp/test-connection', {
                                method: 'POST',
                                headers: getHeaders(),
                                body: JSON.stringify(this.form)
                            });
                            const data = await res.json();
                            this.testSuccess = data.success;
                            this.testResult = data.message;
                            this.$nextTick(() => lucide.createIcons());
                        } catch (err) {
                            this.testSuccess = false;
                            this.testResult = 'Connection test failed: ' + err.message;
                        }
                        this.testing = false;
                    },

                    async saveConnection() {
                        this.saving = true;
                        try {
                            const res = await fetch('/api/erp/save-connection', {
                                method: 'POST',
                                headers: getHeaders(),
                                body: JSON.stringify(this.form)
                            });
                            const data = await res.json();
                            if (data.success) {
                                this.testResult = 'Connection saved and activated!';
                                this.testSuccess = true;
                                await this.fetchCurrentConnection();
                                this.$nextTick(() => lucide.createIcons());
                            } else {
                                this.testResult = data.message || 'Save failed';
                                this.testSuccess = false;
                            }
                        } catch (err) {
                            this.testResult = 'Save failed: ' + err.message;
                            this.testSuccess = false;
                        }
                        this.saving = false;
                    },

                    // ‚îÄ‚îÄ‚îÄ Credentials Methods ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    async checkReauthStatus() {
                        try {
                            const res = await fetch('/api/credentials/reauth-status');
                            const data = await res.json();
                            this.reauthVerified = data.verified;
                        } catch (e) { this.reauthVerified = false; }
                    },

                    async loadCredentials() {
                        try {
                            const res = await fetch('/api/credentials/');
                            const data = await res.json();
                            this.credentials = data.credentials || [];
                            await this.checkReauthStatus();
                            this.$nextTick(() => lucide.createIcons());
                        } catch (e) {
                            console.error('Failed to load credentials', e);
                        }
                    },

                    async revealKey(key) {
                        try {
                            const res = await fetch(`/api/credentials/reveal/${key}`);
                            if (res.status === 403) {
                                window.location.href = '/auth/reauth';
                                return;
                            }
                            const data = await res.json();
                            this.revealedKeys = { ...this.revealedKeys, [key]: data.value || '(empty)' };
                        } catch (e) {
                            alert('Failed to reveal key. Please try again.');
                        }
                    },

                    openEdit(cred) {
                        this.editingCred = cred;
                        this.editValue = '';
                        this.saveMessage = '';
                        this.saveSuccess = false;
                        this.$nextTick(() => lucide.createIcons());
                    },

                    async saveKey() {
                        if (!this.editValue.trim()) {
                            this.saveMessage = 'Value cannot be empty.';
                            this.saveSuccess = false;
                            return;
                        }
                        this.savingKey = true;
                        try {
                            const res = await fetch('/api/credentials/save', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ key: this.editingCred.key, value: this.editValue })
                            });
                            const data = await res.json();
                            if (res.ok) {
                                this.saveMessage = `‚úÖ ${data.message}`;
                                this.saveSuccess = true;
                                // Reload cards
                                await this.loadCredentials();
                                setTimeout(() => { this.editingCred = null; this.editValue = ''; this.saveMessage = ''; }, 1500);
                            } else {
                                this.saveMessage = `‚ùå ${data.detail || 'Save failed'}`;
                                this.saveSuccess = false;
                            }
                        } catch (e) {
                            this.saveMessage = '‚ùå Network error';
                            this.saveSuccess = false;
                        }
                        this.savingKey = false;
                    }
                }
            }
        </script>
</body>

</html>

<div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
        <div class="p-3 rounded-2xl" :class="connected ? 'bg-green-50' : 'bg-gray-50'">
            <i data-lucide="database" class="w-6 h-6" :class="connected ? 'text-green-600' : 'text-gray-400'"></i>
        </div>
        <div>
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Active ERP Connection</h3>
            <p class="text-lg font-bold text-gray-900 mt-0.5" x-text="currentName"></p>
        </div>
    </div>
    <div class="flex items-center gap-3">
        <span class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wider"
            :class="connected ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'"
            x-text="connected ? 'Connected' : 'Not Tested'"></span>
        <span
            class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wider bg-blue-100 text-blue-700"
            x-text="currentType"></span>
    </div>
</div>
</div>

<!-- Connection Form -->
<div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
    <div class="p-6 border-b border-gray-100 bg-gray-50/50">
        <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">
            <i data-lucide="settings" class="w-5 h-5 text-gray-400"></i>
            Configure ERP Connection
        </h2>
        <p class="text-sm text-gray-500 mt-1">Connect your ERP system or use the built-in Python Sample DB for
            demos.</p>
    </div>

    <form @submit.prevent="saveConnection()" class="p-6 space-y-6">
        <!-- Connection Name -->
        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Connection
                Name</label>
            <input x-model="form.connection_name" type="text" placeholder="e.g., Production Database"
                class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
        </div>

        <!-- ERP Type -->
        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">ERP Type</label>
            <select x-model="form.erp_type"
                class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all bg-white">
                <option value="python_db">Python Sample DB (Demo)</option>
                <option value="sap">SAP S/4HANA</option>
                <option value="netsuite">Oracle NetSuite</option>
                <option value="custom">Custom API</option>
            </select>
        </div>

        <!-- Real ERP Fields (shown when not python_db) -->
        <template x-if="form.erp_type !== 'python_db'">
            <div class="space-y-6 p-5 bg-gray-50 rounded-xl border border-gray-100">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">API
                        URL</label>
                    <input x-model="form.api_url" type="url" placeholder="https://your-erp.example.com"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">API Key
                        / Password</label>
                    <input x-model="form.api_key" type="password" placeholder="Enter API key or password"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Database
                            Name</label>
                        <input x-model="form.database_name" type="text" placeholder="e.g., production_db"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-500 uppercase tracking-widest mb-2">Username</label>
                        <input x-model="form.username" type="text" placeholder="admin@company.com"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-black/10 focus:border-gray-300 transition-all">
                    </div>
                </div>
            </div>
        </template>

        <!-- Test Result -->
        <div x-show="testResult" class="p-4 rounded-xl border text-sm font-medium"
            :class="testSuccess ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'">
            <div class="flex items-center gap-2">
                <i :data-lucide="testSuccess ? 'check-circle' : 'x-circle'" class="w-4 h-4"></i>
                <span x-text="testResult"></span>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 pt-2">
            <button type="button" @click="testConnection()"
                class="flex-1 px-5 py-3.5 border-2 border-gray-200 rounded-xl text-sm font-bold text-gray-700 hover:bg-gray-50 transition-all flex items-center justify-center gap-2 active:scale-95"
                :disabled="testing">
                <i data-lucide="wifi" class="w-4 h-4"></i>
                <span x-text="testing ? 'Testing...' : 'Test Connection'"></span>
            </button>
            <button type="submit"
                class="flex-1 bg-slate-900 hover:bg-black text-white px-5 py-3.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95"
                :disabled="saving">
                <i data-lucide="save" class="w-4 h-4"></i>
                <span x-text="saving ? 'Saving...' : 'Save & Activate'"></span>
            </button>
        </div>
    </form>
</div>

<!-- Architecture Info -->
<div class="mt-8 bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
    <h3 class="font-bold text-sm text-gray-800 flex items-center gap-2 mb-3">
        <i data-lucide="info" class="w-4 h-4 text-blue-500"></i>
        About This Architecture
    </h3>
    <p class="text-sm text-gray-600 leading-relaxed">
        ProcureIQ uses an <strong>ERP Adapter pattern</strong> ‚Äî the AI agent works with a unified interface
        regardless of whether you're using the built-in Python Sample DB or a real ERP system.
        Switch between backends without changing a single line of agent code.
    </p>
    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="p-3 bg-gray-50 rounded-xl text-center">
            <p class="text-xs font-bold text-gray-400 uppercase">Python DB</p>
            <p class="text-sm font-bold text-gray-800 mt-1">Default</p>
        </div>
        <div class="p-3 bg-gray-50 rounded-xl text-center">
            <p class="text-xs font-bold text-gray-400 uppercase">Custom</p>
            <p class="text-sm font-bold text-gray-800 mt-1">REST API</p>
        </div>
        <div class="p-3 bg-gray-50 rounded-xl text-center">
            <p class="text-xs font-bold text-gray-400 uppercase">SAP</p>
            <p class="text-sm font-bold text-gray-800 mt-1">OData</p>
        </div>
        <div class="p-3 bg-gray-50 rounded-xl text-center">
            <p class="text-xs font-bold text-gray-400 uppercase">NetSuite</p>
            <p class="text-sm font-bold text-gray-800 mt-1">REST</p>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê NOTIFICATIONS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div x-show="tab==='notifications'" class="space-y-6">

    <!-- Info banner -->
    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 flex items-start gap-3">
        <span class="text-2xl">üìß</span>
        <div>
            <p class="font-bold text-blue-900 text-sm">How it works</p>
            <p class="text-blue-700 text-xs mt-1">
                When stock drops below the threshold, you get an email with an
                <strong>Approve Order</strong> button. Click it ‚Üí the system
                automatically emails your supplier with a purchase order.
            </p>
        </div>
    </div>

    <!-- Owner Email ‚Äî READ ONLY from Google Auth -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="bg-green-50 p-2.5 rounded-xl">
                <i data-lucide="user-check" class="w-5 h-5 text-green-600"></i>
            </div>
            <div>
                <h3 class="font-bold text-gray-900">Owner Alert Email</h3>
                <p class="text-xs text-gray-500">Low-stock alerts and approval requests are sent here ‚Äî set by your
                    Google account</p>
            </div>
        </div>
        <div class="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3">
            <i data-lucide="lock" class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
            <span class="text-sm font-mono text-gray-700 flex-1">{{ user.email if user else 'Not logged in' }}</span>
            <span class="text-xs bg-green-100 text-green-700 font-bold px-2 py-0.5 rounded-full">Google Auth</span>
        </div>
        <p class="text-xs text-gray-400 mt-2">This email is tied to your Google account and cannot be changed here.</p>
    </div>

    <!-- Supplier Email ‚Äî EDITABLE -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="bg-orange-50 p-2.5 rounded-xl">
                <i data-lucide="truck" class="w-5 h-5 text-orange-500"></i>
            </div>
            <div>
                <h3 class="font-bold text-gray-900">Supplier Email</h3>
                <p class="text-xs text-gray-500">Purchase orders are sent here when you approve a reorder</p>
            </div>
        </div>
        <div class="flex gap-3">
            <input type="email" x-model="notif.supplierEmail" placeholder="supplier@example.com"
                class="flex-1 border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-black">
            <button @click="saveNotifEmail('SUPPLIER_EMAIL', notif.supplierEmail)" :disabled="notifSaving"
                class="bg-slate-900 hover:bg-black text-white px-5 py-2.5 rounded-xl text-sm font-bold transition-all active:scale-95 disabled:opacity-50">
                <span x-text="notifSaving ? 'Saving...' : 'Save'"></span>
            </button>
        </div>
        <p class="text-xs text-gray-400 mt-2">You can change this anytime. The new email will be used for the next
            approved order.</p>
    </div>

    <!-- Save feedback message -->
    <div x-show="notifMessage"
        :class="notifSuccess ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'"
        class="border rounded-xl p-3 text-sm font-medium text-center transition-all" x-text="notifMessage">
    </div>
</div>

</main>


<script>
    function erpSettings() {

        return {
            currentName: 'Loading...',
            currentType: '...',
            connected: false,
            testing: false,
            saving: false,
            testResult: '',
            testSuccess: false,
            form: {
                connection_name: 'Python Sample DB',
                erp_type: 'python_db',
                api_url: '',
                api_key: '',
                database_name: '',
                username: ''
            },

            async init() {
                await this.fetchCurrentConnection();
                lucide.createIcons();
            },

            async fetchCurrentConnection() {
                try {
                    const res = await fetch('/api/erp/current', { headers: getHeaders() });
                    const data = await res.json();
                    this.currentName = data.connection_name || 'Python Sample DB';
                    this.currentType = data.erp_type || 'python_db';
                    this.connected = data.test_status === 'success';
                    // Pre-fill form
                    this.form.connection_name = data.connection_name || 'Python Sample DB';
                    this.form.erp_type = data.erp_type || 'python_db';
                    this.form.api_url = data.api_url || '';
                } catch (err) {
                    console.error('Failed to fetch current connection', err);
                }
            },

            async testConnection() {
                this.testing = true;
                this.testResult = '';
                try {
                    const res = await fetch('/api/erp/test-connection', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify(this.form)
                    });
                    const data = await res.json();
                    this.testSuccess = data.success;
                    this.testResult = data.message;
                    this.$nextTick(() => lucide.createIcons());
                } catch (err) {
                    this.testSuccess = false;
                    this.testResult = 'Connection test failed: ' + err.message;
                }
                this.testing = false;
            },

            async saveConnection() {
                this.saving = true;
                try {
                    const res = await fetch('/api/erp/save-connection', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify(this.form)
                    });
                    const data = await res.json();
                    if (data.success) {
                        this.testResult = 'Connection saved and activated!';
                        this.testSuccess = true;
                        await this.fetchCurrentConnection();
                        this.$nextTick(() => lucide.createIcons());
                    } else {
                        this.testResult = data.message || 'Save failed';
                        this.testSuccess = false;
                    }
                } catch (err) {
                    this.testResult = 'Save failed: ' + err.message;
                    this.testSuccess = false;
                }
                this.saving = false;
            },

            // ‚îÄ‚îÄ Notifications tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            notif: { supplierEmail: '', ownerEmail: '' },
            notifSaving: false,
            notifMessage: '',
            notifSuccess: false,

            async loadNotifSettings() {
                try {
                    const res = await fetch('/api/credentials/list', { headers: getHeaders() });
                    const data = await res.json();
                    const creds = data.credentials || [];
                    const supplier = creds.find(c => c.key === 'SUPPLIER_EMAIL');
                    const owner = creds.find(c => c.key === 'OWNER_EMAIL');
                    this.notif.supplierEmail = supplier ? supplier.masked_value : '';
                    this.notif.ownerEmail = owner ? owner.masked_value : '';
                } catch (e) {
                    console.error('Failed to load notif settings', e);
                }
            },

            async saveNotifEmail(key, value) {
                if (!value || !value.includes('@')) {
                    this.notifMessage = 'Please enter a valid email address.';
                    this.notifSuccess = false;
                    return;
                }
                this.notifSaving = true;
                try {
                    const res = await fetch('/api/credentials/save', {
                        method: 'POST',
                        headers: { ...getHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key, value })
                    });
                    const data = await res.json();
                    this.notifSuccess = data.success;
                    this.notifMessage = data.success ? '‚úÖ Saved successfully!' : ('‚ùå ' + (data.detail || 'Save failed'));
                } catch (e) {
                    this.notifSuccess = false;
                    this.notifMessage = '‚ùå Network error';
                }
                this.notifSaving = false;
                setTimeout(() => this.notifMessage = '', 3000);
            }
        }
    }
</script>
</body>

</html>